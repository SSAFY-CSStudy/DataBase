### 5. 역정규화
- 역정규화 (denormalization)
    - 정규화 단계가 진행될수록 중복이 감소하고 갱신 이상도 감소됨
    - 성능 관점에서 높은 정규형을 만족하는 릴레이션 스키마가 최적은 아님
    - 한 정규형에서 다음 정규형으로 진행될 때마다 하나의 릴레이션이 최소한 두개의 릴레이션으로 분해됨
    - 분해되지 전의 릴레이션을 대상으로 질의를 할 때는 조인이 필요 없지만, 분해 되면 조인의 필요성 증가
    
    ![Untitled](https://github.com/SSAFY-CSStudy/DataBase/assets/101400650/994bfea9-5e95-40a0-9498-285ae28c0c3a)
    

## 8장 뷰와 시스템 카탈로그

### 뷰와 시스템 카탈로그

- **뷰와 시스템 카탈로그**
    - **view** 는 다른 릴레이션으로부터 유도된 릴레이션(derived relation)
        - DB의 보안 매카니즘
        - 복잡한 질의를 간단하게 표현하는 수단
        - 데이터독립성을 높이기 위해 사용
    - **시스템 카탈로그**는 시스탬내의 객체(기본 릴레이션, 뷰, 인덱스, 사용자 접근 권한 등)의 관한 정보를 포함
    

### 뷰

- **뷰**
    - 한 사용자의 저네 외부 뷰 대신에 하나의 **가상 릴레이션(virtual relation)**을 의미
    - 기존의 **기본 릴레이션**에 대한 select 문의 형태로 정의됨
    - 릴레이션으로부터 데이터를 검색하거나 갱신할 수 있는 **동적인 창(dynamic window)**의 역할
    
- **스냅샷 (snapshot)**
    - 어느 시점에 select 문의 결과를 기본 릴레이션의 형태로 저장해 놓은 것
    - 스냅샷을 정의하는 시점의 기본 릴레이션의 내용이 스냅샷에 반영됨
    - ex) 사원 정보, 재고 정보

- **뷰와 기본 릴레이션의 관계**
    
    ![Untitled 1](https://github.com/SSAFY-CSStudy/DataBase/assets/101400650/7ec7d9d1-915d-48b2-a392-eced6b6e0edc)

- **뷰의 정의**
    
    `CREATE VIEW 뷰이름 [(애트리뷰트)] AS SELECT문 [WITH CHECK OPTION];`
    
    ![Untitled 2](https://github.com/SSAFY-CSStudy/DataBase/assets/101400650/1909fef1-cead-4fcf-bd84-1867ca248a44)

    ![Untitled 3](https://github.com/SSAFY-CSStudy/DataBase/assets/101400650/7dd9ab3b-c314-4378-8e22-8e5eb6388bc3)

- **뷰를 사용하여 데이터를 접근할 때 관계 DBMS에서 거치는 과정**
    - 시스템 카탈로그로 부터 뷰의 정의 → SELECT 문을 검색
    - 기본 릴레이션에 대한 뷰의 접근 권한을 검사
    - 뷰에 대한 질의를 기본 릴레이션에 대한 동등한 질의로 변환
        
        ![Untitled 4](https://github.com/SSAFY-CSStudy/DataBase/assets/101400650/fd30ec57-84bc-4d95-8875-eff069eb295c)

- **뷰의 장점**
    - 뷰는 복잡한 질의를 간단하게 표현할 수 있게 함
        
        ![Untitled 5](https://github.com/SSAFY-CSStudy/DataBase/assets/101400650/532d5c7a-be53-4290-9398-0799a3c447cf)

    - 뷰는 데이터 무결성을 보장하는데 활용됨
        - 기본적으로 뷰를 통해 튜플을 추가하거나 수정할 때 튜플이 뷰를 정의하는 SELECT문의 WHERE 절의 기준에 맞지 않으면 뷰의 내용에서 사라짐
            
            `UPDATE EMP_DNO3 SET DNO=2 WHERE ENO = 3427;`
            
        - 이 뷰의 정의할 때 `WITH CHECK OPTION`을 명시했다고  가정
            
            `CREATE VIEW EMP_DNO3 (ENO, ENAME, TITLE) AS SELECT EMPNO, EMPNAME, TITLE FROM EMPLOYEE WHERE DNO=3 **WITH CHECK OPTION**;`
            
    - 데이터 보안 기능을 제공함
        - 뷰의 원본이 되는 기본 릴레이션에 직접  접근할 수 있는 권한을 부여하지 않고 뷰를 통해 데이터를 접근하도록 하기 때문에 보안 메커니즘으로 사용할 수 있음
        - 일부 애트리뷰트들 또는 일부 튜플들을 검색하는 SELECT 문으로 정의되므로 뷰를 통해서 기본 릴레이션을 접근하면 기본 릴레이션의 일부만 검색할 수 있음
    - 동일한 데이터에 대한 여러 가지 뷰를 제공함
    
- 뷰의 갱신
    - 뷰에 대한 갱신도 기본 릴레이션에 대한 갱신으로 변환됨
    - 아래의 갱신들이 성공적으로 수행될 수 있는가?
    - **갱신 1** : 한 릴레이션 위에서 정의된 뷰에 대한 갱신
        
        **`INSERT INTO** EMP_DNO3 **VALUES** (4293, ‘김정수’, ‘사원’);` 
        
        → **`INSERT INTO** EMP_DNO3 **VALUES** (4293, ‘김정수’, ‘사원’, ... );` 
        
    - **갱신 2** : 두 개의 릴레이션 위에서 정의된 뷰에 대한 갱신
        
        **`INSERT INTO** EMP_PLANING **VALUES** (‘박지선’, ‘대리’, 250000 );` 
        
        → **`INSERT INTO** EMPlOYEE **VALUES** (, ‘박지선’, ‘대리’, 250000 ... );` 
        
    - 갱신 3 : 집단 함수 등을 포함하는 뷰에 대한 갱신
        
        **`CREATE VIEW** EMP_AVGSAL (DNO, AVGSAL) **AS SELECT** DNO, AVG(SALARY) **FROM** EMPLOYEE **GROUP BY** DNO;`
        
        **`UPDATE** EMP_AVGSAL **SET** AVGSAL = 3000000 **WHERE** DNO = 2;`
        
        **`INSERT INTO** EMP_AVGSAL **VALUES** (3, 3200000);`
        
- 갱신이 불가능한 뷰
    - 한 릴레이션 위에서 정의되었으나 그 릴레이션의 기본 키가 포함되지 않은 뷰
    - 기본 릴레이션의 애트리뷰트들 중에서 뷰에 포함되지 않는 애트리뷰트에 대해 `NOT NULL` 이 지정되어 있을 때
    - 집단 함수가 포함된 뷰
    - 조인으로 정의된 뷰
    
    ![Untitled 6](https://github.com/SSAFY-CSStudy/DataBase/assets/101400650/ab6f5c88-5136-4850-a325-0b8c6390d590)


### 2. 관계 DBMS의 시스템 카탈로그

- **시스템 카탈로그**
    - 데이터베이스의 객체(사용자, 릴레이션, 뷰, 인덱스, 권한 등 )와 구조들에 관한 모든 데이터를 포함
    - **메타데이터** : 데이터에 관한 데이터라는 의미
    - 사용자 및 질의 최적화 모듈 등 DBMS 자신의 구성요소에 의해서 사용됨
    - 관계 DBMS 마다 표준화되어 있지 않아서 관계 DBMS 마다 서로 다른 형태로 시스템 카탈로그 기능을 제공함
    - **데이터 사전** 또는 **시스템 테이블**이라고 부름
- **시스템 카탈로그가 질의 처리에 어떻게 활용되는가**
    - **`SELECT** EMPNAME, SALARY, SALARY * 1.1 **FROM** EMPLOYEE **WHERE** TITLE = ‘과장’ **AND** DNO = 2;`
        - SELECT 문이 문법적으로 정확한가를 검사
        - SELECT 문에서 참조하는 EMPLOYEE 릴레이션이 데이터베이스에 존재하는가를 검사함
        - EMPLOYEE 릴레이션에 SELECT 절에 열거된 애트리뷰트와 WHERE 절에서 조건에 사용된 애트리뷰트가 존재하는가를 확인함
        - SALARY 애트리뷰트가 수식에 사용되었으므로 ㅇ데이터 타입이 정수형인지 실수형 인지를 검사하고, TITLE이 문자열과 비교되었으므로 CHAR 또는 VARCHAR 인가 등을 검사함
        - 질의를 입력한 사용자가 EMPLOYEE 릴레이션의 EMPNAM, SALARY 애트리뷰트를 검색할 수 있는 권한이 있는지 확인
        - TITLE, DNO에 인덱스가 정의되어 있는지 확인
        - 두 애트리뷰트에 각각 인덱스가 존재한다고 가정 → DBMS가 두 인덱스 중에서 조건을 만족하는 튜플 수가 적은 것을 선택하기 위해서는 관계 데이터베이스 시스템에 데이터베이스 외에 추가로 정보를 유지해야 함
        - 한 릴레이션의 전체 투플 수와 그 릴레이션에 정의된 각 인덱스에 존재하는 상이한 값들의 개수를 유지한다면 어느 인덱스를 사용하는 것이 유리한가를 예상할 수 있음
        - EX ) EMPLOYEE 릴레이션의 전체 튜플 수는 7이고, TITLE에는 사원, 대리, 과장, 부장, 시장 → 5가지 존재
            - DNO 1, 2, 3의 세 가지 값들이 존재
            - **TITLE** 에 정의된 인덱스가 DNO에 정의된 인덱스보다 대상 튜플들을 더 좁혀 주므로 **유리**
    
- **질의 최적화**
    - DBMS가 질의를 수행하는 여러가지 방법들 중에서 가장 비용이 적게 드는 방법을 찾는 과정
    - 질의 최적화 모듈이 정확한 결정을 내릴 수 있도록 DBMS는 자체 목적을 위해서 시스템 카탈로그에 다양한 정보를 유지함
    - 사용자가 질의 최적화 모듈을 깊이 있게 이해할 필요는 없지만 질의 최적화 모듈이 정확한 수행 방법을 결정하기 위해서는 릴레이션에 관한 다양한 통계 정보가 정확하게 유지돼야 한다는 것을 알고 있는 것이 바람직
    
- **관계 DBMS의 시스템 카탈로그**
    - 사용자 릴레이션과 마찬가지 형태로 저장되기 때문에 사용자 릴레이션에 적용되는 회복 기법과 동시성 제어 기법을 동일하게 사용할 수 있음
    - 시스템 카탈로그는 사용자 릴레이션처럼 SELECT문을 사용하여 내용을 검색할 수 있음
    - 시스템 카탈로그에는 릴레이션, 애트리뷰트, 인덱스, 사용자, 권한 등 각 유형마다 별도의 릴레이션이 유지됨
    - EMPLOYEE 릴레이션과 DEPARTMENT 릴레이션에 대해서 시스템 카탈로그에 어떤 정보들이 유지되는가를 이해하기 쉽도록 시스템 카탈로그를 매우 단순화하여 설명함
    - 릴레이션에 관한 정보를 유지하는 릴레이션의 이름이 SYS_RELATION, 애트리뷰트에 관한 정보를 유지하는 릴레이션의 이름이 SYS_ATTRIBUTE라고 가정
        
        ![Untitled 7](https://github.com/SSAFY-CSStudy/DataBase/assets/101400650/114e1ba0-f9c2-46d1-9fff-429bfdc6ff5f)

- **시스템 카탈로그의 갱신**
    - 어떤 사용자도 시스템 카탈로그를 직접 갱신할 수 없음
    - 즉 DELETE, UPDATE 또는 INSERT문을 사용하여 시스템 카탈로그를 변경할 수 없음
    - EMPLOYEE 릴레이션의 소유자인 KIM이 EMPLOYEE 릴레이션에서 MANAGER 애트리뷰트를 삭제하기 위해서 `ALTER TABLE EMPLOYEE DROP COLUMN MANAGER;`
    - 라고 하는 대신에 아래와 같이 시스템 카탈로그에 대해 DELETE문을 사용하면 **DBMS가 거절**함
    **`DELETE FROM** SYS_ATTRIBUTE **WHERE** AttRelId = 'EMPLOYEE' **AND** AttName = 'MANAGER';`
    
- **시스템 카탈로그에 유지되는 통계 정보**
    - 릴레이션마다 투플의 크기, 투플 수, 각 블록의 채우기 비율, 블록킹 인수, 릴레이션의 크기(블록 수)
    - 뷰마다 뷰의 이름과 정의
    - 애트리뷰트마다 애트리뷰트의 데이터 타입과 크기, 애트리뷰트 내의 상이한 값들의 수, 애트리뷰트 값의 범위, 선택율 
    (조건을 만족하는 투플 수/전체 투플 수)
    - 사용자마다 접근할 수 있는 릴레이션과 권한
    - 인덱스 마다 인덱스된 애트리뷰트 클러스터링 인덱스/ 비 클러스터링 인덱스 여부, 밀집/ 희소 인덱스 여부, 인덱스 높이, 1단계 인덱스의 블록 수
    
- **MS SQL Server의 시스템 카탈로그**
    - 통계 정보는 **UPDATE STATISTICS**문을 사용하여 수동으로 갱신할 수 있음
    - SQL Server는 릴레이션의 데이터가 변경될 때 주기적으로 통계 정보를 자동으로 갱신함
    - 통계 정보를 갱신할 필요성이 있는가를 확인하기 위해서 샘플링 방법을 사용함
    - 통계 정보가 갱신되는 빈도는 애트리뷰트 또는 인덱스의 크기와 변경되는 데이터의 양에 따라 결정됨
    - 모든 릴레이션들에 대한 구성을 정의하는 데이터를 시스템 테이블이라고 부르는 특수한 테이블 집합에 저장함
    - 사용자나 응용 프로그램이 정보 스키마 뷰, Transact-SQL문 및 함수, 시스템 저장 프로시저 등을 사용하여 시스템 테이블에 저장된 정보를 검색함
